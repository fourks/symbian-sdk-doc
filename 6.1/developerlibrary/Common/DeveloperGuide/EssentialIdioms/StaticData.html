<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html><head>
<title>Static data</title>
<link href="../../../_stock/sysdoc.css" type="text/css" rel="stylesheet" media="screen">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<style type="text/css" media="screen"><!--
.ButtonBox { background-image: url(../../../_stock/gradient.jpg); }
--></style>
</head>
<body><a name="_top"></a><a name="idioms%2estaticdata"></a>
<table width="100%" border="0" cellspacing="0"
cellpadding="0"><tbody><tr><td colspan=2 class="LogoBox"><a><img
src="../../../_stock/symbian.gif" alt="Symbian" width="121"
height="46" border="0"></a><img src="../../../_stock/mainheading.gif"
alt=" Developer Library" height="46" width="183"></td></tr><tr><td
class="DocSetBox" width="33%">
<p><a href="../../../Product/Generic/index.html">SYMBIAN OS V6.1 EDITION FOR C++</a></p>
</td><td class="ButtonBox" align="right" width="67%">
<p><a href="../../../_index/index.html"><img
src="../../../_stock/btn_index.gif" alt="[Index]" width="53"
height="22" border="0"></a> <a href="../../GlobalGlossary/index.html"><img src="../../../_stock/btn_glossary.gif"
alt="[Glossary]" border="0" width="81" height="22"></a> <img src="../../../_stock/btn_spacer.gif"
alt="" width="60" height="22"> <a href="DefensiveProg.guide.html"><img src="../../../_stock/btn_prev.gif"
alt="[Previous]" border="0" width="85" height="22"></a> <a href="FrameworksLibsDlls.html"><img src="../../../_stock/btn_next.gif" alt="[Next]"
border="0" width="58" height="22"></a></p>
</td></tr></table>
<hr noshade size="1">
<p class="breadcrumbNav">&nbsp;<span class="separator">&#187;</span>
<a href="../../../Product/Generic/index.html">Symbian&nbsp;OS&nbsp;v6.1&nbsp;Edition&nbsp;for&nbsp;C++</a>&nbsp;<span class="separator">&#187;</span>
<a href="../../../Product/Generic/DeveloperGuide/index.html">Developer's&nbsp;Guide</a>&nbsp;<span class="separator">&#187;</span>
<a href="index.html">Essential&nbsp;Idioms</a>&nbsp;<span class="separator">&#187;</span>
Static&nbsp;data</p>

<hr noshade size="1">
<div class="AuthoredContent">


</div><div class="Head1">

<h1>Static data</h1>
</div><div class="Bodytext">
<a name="1.3"></a>
</div><div class="Head2">
<hr size="2" noshade>
<h2>Writeable static data in DLLs</h2>
</div><div class="Bodytext">
<p>The Symbian platform is designed for ROM-based computing. A DLL
which is resident in ROM cannot be written to. Although DLLs may in some cases
be RAM loaded, the Symbian platform makes the conservative assumption that no
DLL can be written to. DLLs on the Symbian platform therefore have no data
segment. An immediate consequence is that no DLL may contain writeable static
data, whether initialised or uninitialised.</p>
<p>Static data is any data declared outside a function, e.g.</p>
<p class="CodeBlock"><code>TBufC&lt;20&gt; fileName;<br>void SetFileName()<br>&nbsp;&nbsp;&nbsp;&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;...<br>&nbsp;&nbsp;&nbsp;&nbsp;}</code></p>
<p>Many existing programs make extensive use of this kind of data. On
the Emulator, which runs under Windows on a PC, this will not necessarily cause
problems because DLLs use the underlying Windows DLL mechanisms in which
writeable data is allowed. However, any such code will not compile for
non-Emulator targets. The build will fail with a warning from the petran tool,
which runs as the final stage of the build chain for non-Emulator targets. The
message generated by the petran tool looks like:</p>
<p><code class="ProgramOutput">ERROR: Dll 'MENUITEMS[10008AD0].APP' has uninitialised
data.</code></p>
<p>You must eliminate all writeable static from your DLL in order to
avoid this error. </p>
<p>Because in some cases it is useful for DLLs to maintain data, the
Symbian platform does provide a mechanism which allows a DLL to manage a small
amount of private storage on a per-thread basis, known as thread local storage
— see
<a href="../../APIGuide/Base/ThreadAndProcessManagement/ThreadsAndProcessesOverview.guide.html#ThreadAndProcessManagementOverview%2eThreadsAndProcessesOverview%2emain">Threads and Processes Overview</a>. A per-thread mechanism is chosen to avoid
potential ambiguities which otherwise arise over which of potentially many
users of the DLL should see the data. </p>
<a name="1.3.9"></a>
</div><div class="Head3">
<hr size="1" noshade>
<h3>Porting strategies</h3>
</div><div class="Bodytext">
<p>To eliminate writeable static data may be a large task. In the
general case, you need to collect all your static data into one
<code>struct</code>, and then access this struct through a pointer, which you
must make available to all parts of the program requiring it. </p>
<p>There are several ways to make this pointer available,
including:</p>
<ul>
<li>
<p>adding it as a parameter to every applicable function. This
method may involve considerable code change — not only to functions which use
the writeable static data, but to intermediate functions which call such
functions</p>
</li>
<li>
<p>using DLL thread-local storage, as noted. This method may
cause a performance problem, because the DLL functions are much more complex
than a pointer dereference</p>
</li>
<li>
<p>storing the pointer in various structs and classes which are
available to functions that need them. This involves some code change, but
avoids the disadvantage of having to alter many intermediate functions, and
avoids the disadvantage of frequently accessing thread-local storage</p>
</li>
</ul>
<p>In practice, a combination of all three methods is likely to be
used, to minimise disruption to both code and run-time performance.</p>
<a name="1.3.10"></a>
</div><div class="Head3">
<hr size="1" noshade>
<h3> Design strategies</h3>
</div><div class="Bodytext">
<p> New code should be designed to avoid writeable static. In
object-oriented systems, it is not considered unusual to pass pointers to
global data along with object references, and the <code>this</code> pointer
available in every non-static member function gives access to all members of
that object.</p>
<p>By suitable object-oriented design, most potential uses of
writeable static are avoided naturally.</p>
<a name="1.3.11"></a>
</div><div class="Head3">
<hr size="1" noshade>
<h3>Non-obvious use of writeable static data</h3>
</div><div class="Bodytext">
<p> Sometimes writeable static data appears in a non-obvious way.
For instance, </p>
<p class="CodeBlock"><code>const TRgb(255,255,255) KRgbWhite;</code></p>
<p>defines a constant which will never be written to by Symbian
code. However, since <code>TRgb</code> is a class, its constructor must be
invoked by the C++ run-time system, in order to construct this constant.
Therefore, in hardware terms, this constant is writeable.</p>
<p>This should be avoided by coding such constants as for
example,</p>
<p class="CodeBlock"><code>#define KRgbWhite TRgb(255,255,255)</code></p>
<p>This will cause the class constructor to be invoked at the point
of use, rather than when the DLL is loaded. </p>
<a name="1.4"></a>
</div><div class="Head2">
<table cellpadding="0" cellspacing="0" border="0" width="97%"><tr valign="bottom"><td align="right"><p><a href="#_top"><img alt="[Top]" src="../../../_stock/arrow_up_2.gif" border="0"align="bottom"></a></p></td></tr></table><hr size="2" noshade>
<h2>Writeable static data in EXEs</h2>
</div><div class="Bodytext">
<p> In <code class="filename">.exe</code>s, there is no restriction on writeable static
data. <code class="filename">.exe</code>s such as servers may use writeable static.</p>

</div><div class="Footer">
<hr noshade size="1">
<table cellpadding="0" cellspacing="0" border="0" width="100%">
<tr valign="bottom">
<td><p class="copyrightStatement">Copyright &copy;2002&nbsp; Symbian Ltd. &nbsp; &nbsp; &nbsp;	6.1-00174
</p></td>
<td align="right"><p><a href="#_top"><img
alt="[Top]" src="../../../_stock/arrow_up.gif" border="0"
align="bottom"></a></p></td>
</table>
</div>
</body>
</html>
